var Messaging=(function(){var c;var b;var a;var d={};return{setOptions:function(e){this.devKey=e.key;this.serverUrl=e.url;this.clientId=Naming.getClientId();PollingTransport.setDuration(1000);PollingTransport.start()},setDeveloperKey:function(e){this.devKey=e},getDeveloperKey:function(){return this.devKey},setClientId:function(e){this.clientId=e},getClientId:function(){return this.clientId},setServerUrl:function(e){this.serverUrl=e},getServerUrl:function(){return this.serverUrl},setListener:function(e,f){console.log("Messaging set listener for "+e);d[e]=f},removeListener:function(e){delete d[e]},sendToService:function(f,g,e){this.send({service:f,msg:g},e)},sendToClient:function(f,g,e){this.send({to:f,service:"courier",msg:g},e)},send:function(g,f){var e=this;g.from=e.clientId;console.log("Messaging.send "+JSON.stringify(g));Ext.Ajax.request({method:"POST",url:e.serverUrl+"/send",params:{key:e.devKey},jsonData:g,scope:e,success:function(h){f()},failure:function(h){f("error")}})},receive:function(e){console.log("Messaging.receive "+JSON.stringify(e));if(d[e.service]){d[e.service](e)}else{console.log("No listener for "+e.service)}},subscribe:function(g,f){var e=this;console.log("Messaging.subscribe "+g);Ext.Ajax.request({method:"POST",url:e.serverUrl+"/subscribe",params:{key:e.devKey,client_id:e.clientId,service:g},jsonData:{},scope:e,success:function(h){f()},failure:function(h){f("error")}})},unsubscribe:function(g,f){var e=this;console.log("Messaging.unsubscribe "+g);Ext.Ajax.request({method:"POST",url:e.serverUrl+"/unsubscribe",params:{key:e.devKey,client_id:e.clientId,service:g},jsonData:{},scope:e,success:function(h){f()},failure:function(h){f("error")}})}}})();var Rpc=(function(){var d=0;var e={};var f=function(){return ++d};var b=function(h,i){e[h]=i};var c=function(j,i){var h=f();j.msg["corr-id"]=h;j.from=Messaging.getClientId();Messaging.send(j,function(){b(h,i)})};var g=function(h,i){h=parseInt(h);if(!e[h]){console.log("Error, no associated call with this envelope available: "+h)}else{e[h](i.msg.result);delete e[h]}};var a=function(h){g(h.msg["corr-id"],h)};Messaging.setListener("rpc",a);return{call:function(i,k,j,m,h){Messaging.setListener(k,a);if(j=="subscriber"){var l={service:k,from:Messaging.getClientId(),msg:{method:m,args:h}};c(l,i)}else{if(j=="direct"){var l={service:"rpc",from:Messaging.getClientId(),msg:{service:k,method:m,args:h}};c(l,i)}else{throw"Invalid RPC style: "+j}}}}})();var Proxy=function(a,b){this.name=a;this.descriptor=b;if(this.descriptor.kind!="rpc"){throw"Error, proxy does not support non-rpc calls"}this._createMethodProxies()};Proxy.prototype._createMethodProxies=function(){var b=this;for(var c=0;c<this.descriptor.methods.length;c++){var a=this.descriptor.methods[c];b[a]=b._createMethodProxy(a)}};Proxy.prototype._createMethodProxy=function(b){var a=this;return function(){arguments.slice=Array.prototype.slice;var c=arguments.slice(0);var d=a.descriptor.style[0];if(a.descriptor.style.indexOf("subscriber")>0){d="subscriber"}Rpc.call(c[0],a.name,d,b,c.slice(1))}};var Naming=(function(){var c=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(f){var e=Math.random()*16|0,d=f=="x"?e:(e&3|8);return d.toString(16)})};var b=function(){var d=null;try{if("localStorage" in window&&window.localStorage!==null){d=window.localStorage.clientId}}catch(f){d=null}return d};var a=function(d){window.localStorage.clientId=d};return{getClientId:function(){var d=b();if(!d){d=c();a(d)}return d},getServiceDescriptor:function(e,d){if(e=="naming-rpc"){d({kind:"rpc",style:["direct"],access:["clients"],depends:["messaging","naming"],methods:["getServiceDescriptor"]})}else{Service.get("naming-rpc",function(f){f.getServiceDescriptor(function(g){if(g.status=="success"){d(g.value)}else{d(null)}},e)})}}}})();var Service=(function(){var a={};return{get:function(d,c){var b=a[d];if(b){c(b)}else{Naming.getServiceDescriptor(d,function(e){if(e==null){c(null)}else{b=new Proxy(d,e);a[d]=b;c(b)}})}}}})();var PollingTransport=(function(){var a;var b=5*1000;return{setDuration:function(c){b=c},start:function(){var c=this;a=setInterval(function(){console.log("PollingTransport requesting...");Ext.Ajax.request({method:"POST",url:Messaging.getServerUrl()+"/receive",params:{key:Messaging.getDeveloperKey(),client_id:Messaging.getClientId()},jsonData:{},scope:c,success:function(d){console.log("PollingTransport response: "+d.responseText);var e=Ext.decode(d.responseText);if(e!==null){Messaging.receive(e)}},failure:function(d){console.log("PollingTransport error on receive: "+d.status)}})},b)},stop:function(){clearInterval(a)}}})();var SocketIoTransport=(function(){})();